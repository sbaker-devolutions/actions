name: Semgrep
description: Must run under ubuntu

inputs:
  rules:
    description: Rules
    default: p/default
    required: true
  timeout:
    description: Timeout default 1800 seconds (30 minutes). Set to 0 to disable.
    default: '1800'
    required: true
  
runs:
  using: composite

  steps:
    - uses: actions/checkout@v3

    # - name: Setup homebrew
    #   uses: Homebrew/actions/setup-homebrew@master

    # - run: brew install cyclonedx/cyclonedx/cyclonedx-cli

    - run: python3 -m pip install semgrep
      shell: bash

    - run: echo Rules - $rules
      shell: bash

    - run: echo Rules ${{ env.rules }} 
      env:
        rules: ${{ github.event.inputs.rules }}
        timeout: ${{ github.event.inputs.timeout }}
      shell: bash

    - run: semgrep ci -c p/default --timeout 1800 -o semgrep_result.txt --suppress-errors 
      env:
        rules: ${{ github.event.inputs.rules }}
        timeout: ${{ github.event.inputs.timeout }}
      shell: bash

    - uses: actions/upload-artifact@v3
      with:
        name: semgrep_result.txt
        path: semgrep_result.txt
